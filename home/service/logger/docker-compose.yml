version: "3.5"

services:

  kibana:
    build:
      context: kibana
    depends_on:
      - elasticsearch
    labels:
      - traefik.backend=kibana
      - traefik.frontend.rule=Host:kibana.my127.site
      - traefik.docker.network=${TRAEFIK_NETWORK}
      - traefik.port=5601
    networks:
      shared:
        aliases:
          - monitoring_kibana
      private:
        aliases:
          - kibana

  elasticsearch:
    build:
      context: elasticsearch
    environment:
      ES_JAVA_OPTS: "-Xmx512m -Xms512m"
    labels:
      - traefik.enable=false
    networks:
      private:
        aliases:
          - elasticsearch

  filebeat:
    build:
      context: filebeat
    depends_on:
      - elasticsearch
      - kibana
    volumes:
     - filebeat_data:/usr/share/filebeat/data:rw
     - /var/lib/docker/containers:/var/lib/docker/containers
     - /var/run/docker.sock:/var/run/docker.sock
    labels:
      - traefik.enable=false
    networks:
      private:
        aliases:
          - filebeat

  metricbeat:
    build:
      context: metricbeat
    depends_on:
      - elasticsearch
      - kibana
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc:/hostfs/proc:ro
      - /sys/fs/cgroup:/hostfs/sys/fs/cgroup:ro
    command: ["-system.hostfs=/hostfs"]
    labels:
      - traefik.enable=false
    networks:
      private:
        aliases:
          - metricbeat
      monitoring:
        aliases:
          - monitoring_metricbeat

volumes:
  filebeat_data: ~

networks:
  private:
    external: false
  monitoring:
    external:
      name: ${TRAEFIK_NETWORK}_monitoring
  shared:
    external:
      name: ${TRAEFIK_NETWORK}
